package lastpass_test

import (
	"context"
	"fmt"
	"log"
	"net/http"
	"strings"

	. "github.com/onsi/ginkgo"
	. "github.com/onsi/gomega"
	"github.com/onsi/gomega/ghttp"

	. "github.com/ansd/lastpass-go"
)

var _ = Describe("Log", func() {
	var server *ghttp.Server
	var logger Logger
	var logs strings.Builder
	var err error
	const user = "lpass-go4@mailinator.com"
	const passwd = "a3SH155*Yb79"
	const privateKeyEncrypted = "902C0BACDAA170C625B1DF8A452DBE0F4A60A101B4EE73587FB3BF7E2E4F51E8D4BC9297D9F10DF0A0D5B34F71549D4409F5245E6436633EC954B828B330CB488CDBE8A27A5CB9988B1DBC503666AB0DDC843472D6995DF018920700FD27510F59C57F0313B0E6CCE933687B90E7F3717E7702660A4F86DDEE962348518C84C3E3251463DC4E95A88BB5529E17E2C98123383B0B777C70634DD7242F761CCCB6E3DBFF69B6CA7F91EFEB98879411A72EC85CA649D88947AEFEBF653096F8FC425019D83EFBAA8C94C499708F7E27BD457B4A37DC48A4F27CF57BDDF8244F3484A6F0807575A2EB42D73C0B929975E0285AA9F893A49DED34FA5EE0E377CC35493121C08FCBCDD46FD4C2B1FA414D86024177CF89A960EACE7C96E5A8154888CA1D1962C3A659C0A6CDFA88373D56F7AA17507728E3D0C38280040385106FB4913C36B4A8DA40A6E8E131435803AD9C8869697DDD0C816B15312554B1B4709BCC48E50D20AAA4D4366BAB1B31570AAD48CBB9EFA24FD13473142056E36942CF583467FB01DAC9CB76792DFF49798E357598DC7CF85096EA6F28C821B8ED38D66E1658F8D7851C0D7C9287D4097C553F42557E6E7ECD32F3A6A44D47FA1BCBAB395878B15CC3B225E2AFA0EDC497C1B8CE364B8EEAF5D903D17147B290F250EC0C7FDA63932AEEE451793B0501B9034242C39943877197CD494251C3014F265A38D47EDD8277C7722D5C209502954A8D569C8A030A1648C2437CF11153CBEE795F361202458CE081F3DCD7C85AB86ACBA3A49AE2C9B3748A8840A32C2FE0EAB89F58D44901C169106A261956CC0FC761C52238807A73E4186D39A6EB34F5C718AA1801E325AA3A2119B1A626598FA9FAE2D0B3D0C496C587031A1C15D59B86DA16A46C1A199CF21D4E0878693E3C4719AC9988B0C48C4116DCDD08634ACB61076160F957974617B8F13994D7E5B81D2C079B0C65FC4D46956E68C29FA65251CD4385B25B8F32AE4EAD96AB8D996A83E1601A9AF49589DD650D08745FFD4EAC4A4E57FF941EBA5AC3C5510B3482A841034707044C402B4F5BA53359AB1EA25747F171BFE83CA86182D5C25CE86F3661F5E7779DF7F3E6BB3DB74DC159F14C505AA9211FF61E42FEDE737CD6EBF16248D8E182A94719E0C54F8EEC293056DBA411C2B40A436544A05E8A4978FE6F33C0C9D02AC7AE01311E8DA2E6270F6E02075750D02FD4E1D07A3ECCA6D92AD94C8E92C1966F2C16C6A3B9C60D7075EAC45C03ECC3575649D28DD711CDBEA484CA789D1BDFA2BD7FED4864969C33AFF8F57929104C254E31097F7888835225995711E42B7D31AAB804A67E9BE8E47DD346654F70F8DD6C66D6A84BE08DB4754FCE3723DF696144817C1FDB9F800B3D55ABC8B738171B9E0315F41D612496A8B0108B6F4C4F23187845F72674CBF023D8E5AA22C19952B44101F8F0E6D8EB836AFF39A09159E366C9BDC878A625355A8EE771A9D9511E8839229025583FAEDF199347BC33D220A205EE9FDB651EC7D75A90C98409F42B13D994A6E9E7F8476736266B5B7C5D40B9B30B618238AD646925C3E1E8921351177B74C9AC83FC7B88EAE66291CD729E14C47AF92AE46554CCA331F266448F3A0128557676C2CB3B4DC6EF813484324F9AF34CF74BF0FADCD580E440696C0B887647724605B0E15D62BF7114920278984ECBD9280F1AF76CF5947A124A05B19D72A01185DEF591B27CB9BCC51D4F00F0A0E59717668724307DB594769221997F001FAD9D4E3FB9526D324A7C5AA01A40B21CDD9241C71B86908DC65B18FA3629B1331FDDA4DF7B939C93B2B47DCEA473DD9A9521C8253819253A2E11E6286B155DC1B683D62B13423CA04F0AF25136815F3453749303ABAC897AEB85E3A380AE2FD3F250B48A6BBB46EC44BC66DBDD28FE57515EE20CCA47C02C8CB5285F2BDE2D6B848AF9C5380B58874CEE260723A657EE8E99AC02BCA974076E53F3607F221AAC8A3AF5D35757FC110BBE9F308A7C7F6704BC32EF89A21178C2BFA03223720037B68F45C73F628F09A772EC3C04CE0EB10D21B71C7E5BD92FC92BD40A600A06F78E5C81B9E5765893A23B7053A7077F4A5A33E2FC11F0A6166F6134177905B2D05A0CDF5B780CD168F49E072997EACDD6815CAD8CE075FD8F482BA699AFB7CF7C4B8962F0439B2F5A9DB79087E9DC32F6D110F654B5A50E0C9E49886B4AA8541F72F6A547A612514996D2DD83B68D350F9B7592511AC60A97606D274A1CFF1CF06AE5E81C7F4241D4756E3E2379B0EE42C9556EF7E4762EFC070C5843D7E49BC1E6CEC826B0A0873D7F07668648A4C72F3F44D3BBF082F31840B2CAE424BB15BA4D2808CAF2CD5B2AF97B49FE30910150B707347522A32C30FCCB72CDCCEF4D83A49A8E211FB2CC74322CF7BE9527601F53D76F2B95ADC477EB222CCF5D98D686F90188F8F5EE94352120CE41DB03168B96F4CCC8D532A1FE005B1178D35A82414D45D4CA0C85A797C35F244612C76ADCCEFBC9D6A4FDC256B11FD317994010C4E1EE13AA8C15760EB0408822BC9626763398FDAEB97B1AA52369265778EA5936B65A46C97E672E0CB7CBF0CB5754645F748B399DE2716E1884F35E816BE331FA0B036F6D2D973AF52D68D9C55C11E3F5F018ABBD3D0DBC98AB11F0007B570F117AF7EFF9F0A7B4306CBCB7ACC4DFA533C63A5265488E3D9B2B9DD21892D9FAE4EA27BC2299C881B59D21F8FF36CF34124526C2B6F27F8C0917828FC64257591707CB306BB424ACFC968D9EC0D7B649437F5E62DF4678070D8BC28BD2C621419A2743191AF76DE60789D1AEE7F4A29034D01329DE0B3862533D18AA76424690DAE08E75DA1071794C2D996DC506CCA1A20C895C6D541A5FA3F88D0407B707F75C5BFD9411D4A938B316A67ED15FDF87878F9EDDDBB43D4F02B04D0DE11865D11BDBD2BD08002059071905A2AF7E88F7841546A78DD7F05A4B13E74BDC2309BC1C64CDF2FEC2099BE86EB5B8A1017E00876B503FED15CC3D658000634373D27360710EE76AF88370A4A1EFDB5DE6E16D7E925EBB333472B4137BC27FC5DB99CF0403965F5755FD7B7D1B2EE2BFBA51A1425C8240403D41F3B57B11B9AD3372275CFFA8F09F3BF5D7DB146B27616E51845A36AF59C8D26D315392D190C99F63BFE1C99C0F378A57DB4D53E3D954496F8A44CD0C2076385E278DB68CE1D7B3C0C60559155851A4B4DE344F3ABA6C88F8126ED6C4B694EAD1C18BE2C3BB1BB0733A991C51D9DF6A1E92BE1A28F59C9EB4DF7E0C90930B7DB3142CDC5393FF5671E4FD1768363AFB219EEEFC8E36A87DF959DAFA1BA7475888538C6321554062D40963EBE7337CFF5DDEC0B1509C201B341CD6D490EE06BF874CD8347A786E538095781A354A237AFE3749BFC11E243F1D781483B78D1E5B6F9390C5FF0BF80A372749AD05DCFE544E17B17AE773CE962EF7D0329F19BD6E29ECB1EE46F8074F38FAEC60B2FC681E7AAF726DB143F6"

	BeforeEach(func() {
		server = ghttp.NewServer()
		server.AppendHandlers(
			ghttp.CombineHandlers(
				ghttp.VerifyRequest(http.MethodPost, EndpointIterations),
				ghttp.RespondWith(http.StatusOK, "100100"),
			),
		)
		server.AppendHandlers(
			ghttp.CombineHandlers(
				ghttp.VerifyRequest(http.MethodPost, EndpointLogin),
				ghttp.RespondWith(http.StatusOK, fmt.Sprintf("<ok token=\"%s\" privatekeyenc=\"%s\" />",
					"fakeToken", privateKeyEncrypted)),
			),
		)
		logger = log.New(&logs, "", 0)
	})

	AfterEach(func() {
		Expect(err).NotTo(HaveOccurred())
		lines := strings.Split(logs.String(), "\n")
		Expect(lines[0]).To(MatchRegexp("^POST http://127.0.0.1:[0-9]{1,5}/iterations.php$"))
		Expect(lines[1]).To(MatchRegexp("^POST http://127.0.0.1:[0-9]{1,5}/login.php$"))
		server.Close()
	})

	Describe("NewContextWithLogger()", func() {
		It("writes logs", func() {
			_, err = NewClient(
				NewContextWithLogger(context.Background(), logger),
				user, passwd,
				WithBaseURL(server.URL()))
		})
	})
	Describe("WithLogger()", func() {
		It("writes logs", func() {
			_, err = NewClient(context.Background(), user, passwd,
				WithBaseURL(server.URL()),
				WithLogger(logger))
		})
	})
})
